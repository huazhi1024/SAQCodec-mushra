<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>MUSHRA 打分界面</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9fafb;
      color: #333;
    }
    .container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      gap: 20px;
    }
    .left-panel {
      flex: 0 0 300px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    .right-panel {
      flex: 1;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .instructions {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-size: 14px;
      line-height: 1.5;
    }
    table.score-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    table th, table td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      text-align: center;
    }
    table th {
      background-color: #f5f5f5;
      font-weight: 600;
    }
    .group-control {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
    }
    .group-control button {
      padding: 8px 20px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .group-control button:hover {
      background-color: #0056b3;
    }
    .group-control button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .group-info {
      font-size: 15px;
      font-weight: 600;
      color: #444;
      min-width: 120px;
      text-align: center;
    }
    .group {
      display: none;
      margin-bottom: 20px;
    }
    .active {
      display: block;
    }
    input[type="number"] {
      width: 60px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }
    input[type="number"]:focus {
      border-color: #007bff;
      outline: none;
    }
    audio {
      width: 200px;
      height: 32px;
    }
    .progress {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
      color: #555;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-top: 15px;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      resize: vertical;
    }
    .result-buttons {
      text-align: center;
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .result-buttons button {
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .collect-btn {
      background-color: #28a745;
    }
    .collect-btn:hover {
      background-color: #218838;
    }
    .download-btn {
      background-color: #17a2b8;
    }
    .download-btn:hover {
      background-color: #138496;
    }
    .clear-btn {
      background-color: #dc3545;
    }
    .clear-btn:hover {
      background-color: #c82333;
    }
    .rating-scale {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.4;
    }
    .rating-scale p {
      margin: 5px 0;
      padding-left: 10px;
      border-left: 3px solid;
    }
    .rating-scale p:nth-child(1) { border-color: #28a745; }
    .rating-scale p:nth-child(2) { border-color: #5cb85c; }
    .rating-scale p:nth-child(3) { border-color: #ffc107; }
    .rating-scale p:nth-child(4) { border-color: #fd7e14; }
    .rating-scale p:nth-child(5) { border-color: #dc3545; }

    /* 新增的样式 */
    .missing-scores {
    color: #dc3545;
    font-weight: bold;
    margin-top: 10px;
    }
    .highlight-missing {
    background-color: #fff3f3;
    }
    .missing-score-input {
    border-color: #dc3545 !important;
    }
    /* 新增的样式 */
    /* 添加在现有样式表的最后 */
    .missing-score-input {
      border-color: #dc3545 !important;
    }
    .highlight-missing {
      background-color: #fff3f3;
    }
  /* 新增弹窗样式 */
  .completion-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
    }
    /*  */
  </style>
</head>
<body>


  <!-- 这里是页面的正式内容 -->
<div class="container">
  <!-- 左侧固定评分规则面板 -->
  <div class="left-panel">
    <h1>MUSHRA 测试</h1>
    
    <div class="instructions">
      <h2>打分说明</h2>
      <!-- <p>请根据<span style="color: red; font-weight: bold;">每个音频与参考音频的音质差异</span>（从内容、音色、韵律、响度和噪声几个角度比较）进行 0–100 分的评分：</p> -->

      
      <!-- <p>请根据<strong style="color: red;">每个音频与参考音频的音质差异</strong>（从
        <span style="color: blue;">内容(能否听清每个字)</span>、
        <span style="color: blue;">音色(说话人是否一致)</span>、
        <span style="color: blue;">韵律(语调节奏是否一致)</span>、
        <span style="color: blue;">响度(音量是否稳定)</span>和
        <span style="color: blue;">噪声(背景是否干净)</span>）5个角度比较进行 0–100 分的评分：</p> -->

        <p>
          请根据 <strong style="color: red;">每个音频与参考音频的音质差异</strong> 进行 0–100 分的评分，比较的角度包括：
        </p>
        <ul style="line-height: 1.8; margin-left: 20px;">
          <li><span style="color: blue;">内容</span>：能否听清每个字</li>
          <li><span style="color: blue;">音色</span>：说话人是否一致</li>
          <li><span style="color: blue;">韵律</span>：语调节奏是否一致</li>
          <li><span style="color: blue;">响度</span>：音量是否稳定</li>
          <li><span style="color: blue;">噪声控制</span>：背景是否干净</li>
        </ul>
        
        
      <div class="rating-scale">
        <p><b>85–100</b>：几乎透明（Excellent），与参考几乎无差别</p>
        <p><b>70–85</b>：良好，轻微差别</p>
        <p><b>50–70</b>：一般，明显下降</p>
        <p><b>20–50</b>：差，有严重失真</p>
        <p><b>0–20</b>：非常差，极度刺耳或无法接受</p>
      </div>
      
      <p><strong>注意：可以反复播放音频进行比对，仔细听辨后再打分</strong>。</p>  
    </div>
  </div>

  <!-- 右侧主要内容区域 -->
  <div class="right-panel">
    <div class="group-control">
      <button id="prev-group" disabled>上一组</button>
      <div class="group-info">第 <span id="current-group">1</span> 组 / 共 <span id="total-groups">15</span> 组</div>
      <button id="next-group">下一组</button>
    </div>

    <div id="groups">
      <!-- 动态生成组内容 -->
    </div>

    <div class="progress" id="overall-progress"></div>

    <h2>评分结果</h2>
    <textarea id="results" readonly placeholder="点击【收集打分】按钮，会生成文本"></textarea>

    <div class="result-buttons">
      <button class="collect-btn" onclick="collectScores()">收集打分</button>
      <button class="download-btn" onclick="downloadScores()">保存打分文件</button>
      <button class="clear-btn" onclick="clearScores()">清空打分</button>
    </div>
  </div>
</div>


<!-- 完成提示弹窗 -->
<div id="completionModal" class="completion-modal">
  <div class="modal-content">
    <h3>评分完成</h3>
    <p>您已完成所有评分！</p>
    <button onclick="downloadAndClose()">保存并下载结果</button>
    <button onclick="closeModal()">仅查看结果</button>
  </div>
</div>




<script>
  const totalGroups = 24; //这里是设置组数的
  const modelsPerGroup = 10;
  let currentGroupIndex = 0;

  const groupsContainer = document.getElementById('groups');
  document.getElementById('total-groups').textContent = totalGroups;

  // 生成组
const audioGroups = [
  
  
 

// ////////////////~1000bps(ETDSO3G-H)//////////////////////////////
{
    groupName: "Group1 (Bitrate: ~1000bps)", //
    refAudio: "audio/GT/GT_testAditi-snips-test-288.wav",
    refSubtitle: "What is the forecast for starting at 3 a.m. in Dubults for wrong weather?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_testAditi-snips-test-288.wav" , hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_testAditi-snips-test-288.wav" , hidden_method: "M5" },
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_testAditi-snips-test-288.wav" , hidden_method: "M7" },
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_testAditi-snips-test-288.wav", hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_testAditi-snips-test-288.wav", hidden_method: "M15" },
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-288.wav", hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-288.wav", hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_testAditi-snips-test-288.wav", hidden_method: "M3" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group2 (Bitrate: ~1000bps)", 
    refAudio: "audio/GT/GT_testAditi-snips-test-531.wav",
    refSubtitle: "Look for the television show me the prince", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_testAditi-snips-test-531.wav", hidden_method: "M2" },
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_testAditi-snips-test-531.wav", hidden_method: "M5" },
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_testAditi-snips-test-531.wav", hidden_method: "M7" },
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_testAditi-snips-test-531.wav", hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_testAditi-snips-test-531.wav", hidden_method: "M15" },
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-531.wav", hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-531.wav", hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_testAditi-snips-test-531.wav" , hidden_method: "M3"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group3 (Bitrate: ~1000bps)", //
    refAudio: "audio/GT/GT_testAditi-snips-test-580.wav",
    refSubtitle: "Please find me the journal of the british astronomical association movie.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_testAditi-snips-test-580.wav" ,hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_testAditi-snips-test-580.wav" ,hidden_method: "M5"},
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_testAditi-snips-test-580.wav" ,hidden_method: "M7"},
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_testAditi-snips-test-580.wav" ,hidden_method: "M11"},
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_testAditi-snips-test-580.wav",hidden_method: "M15" },
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-580.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-580.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_testAditi-snips-test-580.wav",hidden_method: "M3" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group4 (Bitrate: ~1000bps)", // 
    refAudio: "audio/GT/GT_test_clean_1320-122612-0007.wav",
    refSubtitle: "Chingachgook had caught the look, and motioning with his hand, he bade him speak.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_test_clean_1320-122612-0007.wav",hidden_method: "M2" },
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_test_clean_1320-122612-0007.wav" ,hidden_method: "M5"},
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_test_clean_1320-122612-0007.wav" ,hidden_method: "M7"},
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_test_clean_1320-122612-0007.wav",hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_test_clean_1320-122612-0007.wav",hidden_method: "M15" },
      { id: 6, path: "audio/speex/3000bps/GT_test_clean_1320-122612-0007.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_test_clean_1320-122612-0007.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_test_clean_1320-122612-0007.wav",hidden_method: "M3" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group5 (Bitrate: ~1000bps)", // 
    refAudio: "audio/GT/GT_test_clean_7729-102255-0036.wav",
    refSubtitle: "He planted a company before the hotel and demanded a surrender of the arms belonging to the Free State Military Companies.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_test_clean_7729-102255-0036.wav" ,hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_test_clean_7729-102255-0036.wav",hidden_method: "M5" },
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_test_clean_7729-102255-0036.wav",hidden_method: "M7" },
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_test_clean_7729-102255-0036.wav",hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_test_clean_7729-102255-0036.wav",hidden_method: "M15" },
      { id: 6, path: "audio/speex/3000bps/GT_test_clean_7729-102255-0036.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_test_clean_7729-102255-0036.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_test_clean_7729-102255-0036.wav",hidden_method: "M3" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group6 (Bitrate: ~1000bps)", // 
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Could you increase the heating?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M5"},
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M7"},
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M15"},
      { id: 6, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M3"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group7 (Bitrate: ~1000bps)", //
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Okay, now switch the main language to Korean.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M5"},
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M7" },
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M11" },
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M15"},
      { id: 6, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M3"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group8 (Bitrate: ~1000bps)", // 
    refAudio: "audio/GT/GT_260-123286-0028.wav",
    refSubtitle: "Its jaw is enormous and according to naturalists it is armed with no less than one hundred and eighty two teeth.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/1k/EC1k_260-123286-0028.flac" ,hidden_method: "M2"},
      { id: 2, path: "audio/recon/TiCodec/1k/TC1k_260-123286-0028.flac" ,hidden_method: "M5"},
      { id: 3, path: "audio/recon/DAC/1k/DAC1k_260-123286-0028.flac" ,hidden_method: "M7"},
      { id: 4, path: "audio/recon/SemantiCodec/1.25k/SC1.25k_260-123286-0028.flac" ,hidden_method: "M11"},
      { id: 5, path: "audio/recon/Ours/0.97k/Ours0.97k_260-123286-0028.flac" ,hidden_method: "M15"},
      { id: 6, path: "audio/speex/3000bps/GT_260-123286-0028.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_260-123286-0028.wav",hidden_method: "M0"}, //hidden reference
      { id: 8, path: "audio/recon/HC/1k/HC1k_260-123286-0028.flac" ,hidden_method: "M3"},
      // 添加更多模型音频...
    ]
  },

// ////////////////~500bps(ETDSO3G)//////////////////////////////
{
    groupName: "Group9 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-288.wav",
    refSubtitle: "What is the forecast for starting at 3 a.m. in Dubults for wrong weather?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_testAditi-snips-test-288.wav" ,hidden_method: "M1"},
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_testAditi-snips-test-288.wav",hidden_method: "M4" },
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_testAditi-snips-test-288.wav" ,hidden_method: "M6"},
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_testAditi-snips-test-288.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_testAditi-snips-test-288.wav" ,hidden_method: "M14"},
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-288.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-288.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group10 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-531.wav",
    refSubtitle: "Look for the television show me the prince", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_testAditi-snips-test-531.wav" ,hidden_method: "M1"},
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_testAditi-snips-test-531.wav",hidden_method: "M4" },
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_testAditi-snips-test-531.wav",hidden_method: "M6" },
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_testAditi-snips-test-531.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_testAditi-snips-test-531.wav",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-531.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-531.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group11 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-580.wav",
    refSubtitle: "Please find me the journal of the british astronomical association movie.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_testAditi-snips-test-580.wav" ,hidden_method: "M1"},
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_testAditi-snips-test-580.wav" ,hidden_method: "M4"},
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_testAditi-snips-test-580.wav" ,hidden_method: "M6"},
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_testAditi-snips-test-580.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_testAditi-snips-test-580.wav" ,hidden_method: "M14"},
      { id: 6, path: "audio/speex/3000bps/GT_testAditi-snips-test-580.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_testAditi-snips-test-580.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group12 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_test_clean_1320-122612-0007.wav",
    refSubtitle: "Chingachgook had caught the look, and motioning with his hand, he bade him speak.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_test_clean_1320-122612-0007.wav" ,hidden_method: "M1"},
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_test_clean_1320-122612-0007.wav" ,hidden_method: "M4"},
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_test_clean_1320-122612-0007.wav" ,hidden_method: "M6"},
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_test_clean_1320-122612-0007.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_test_clean_1320-122612-0007.wav",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_test_clean_1320-122612-0007.wav" ,hidden_method: "M16"},
      { id: 7, path: "audio/GT/GT_test_clean_1320-122612-0007.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group13 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_test_clean_7729-102255-0036.wav",
    refSubtitle: "He planted a company before the hotel and demanded a surrender of the arms belonging to the Free State Military Companies.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_test_clean_7729-102255-0036.wav",hidden_method: "M1" },
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_test_clean_7729-102255-0036.wav",hidden_method: "M4" },
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_test_clean_7729-102255-0036.wav",hidden_method: "M6" },
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_test_clean_7729-102255-0036.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_test_clean_7729-102255-0036.wav",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_test_clean_7729-102255-0036.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_test_clean_7729-102255-0036.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group14 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Could you increase the heating?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M1" },
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M4" },
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M6" },
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group15 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Okay, now switch the main language to Korean.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M1" },
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M4"},
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M6"},
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group16 (Bitrate: ~500bps)", // 
    refAudio: "audio/GT/GT_260-123286-0028.wav",
    refSubtitle: "Its jaw is enormous and according to naturalists it is armed with no less than one hundred and eighty two teeth.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/EnCodec/0.5k/EC0.5k_260-123286-0028.flac",hidden_method: "M1" },
      { id: 2, path: "audio/recon/TiCodec/0.5k/TC0.5k_260-123286-0028.flac" ,hidden_method: "M4"},
      { id: 3, path: "audio/recon/DAC/0.5k/DAC0.5k_260-123286-0028.flac" ,hidden_method: "M6"},
      { id: 4, path: "audio/recon/SemantiCodec/0.63k/SC0.63k_260-123286-0028.flac" ,hidden_method: "M10"},
      { id: 5, path: "audio/recon/Ours/0.47k/Ours0.47k_260-123286-0028.flac",hidden_method: "M14" },
      { id: 6, path: "audio/speex/3000bps/GT_260-123286-0028.wav",hidden_method: "M16" },
      { id: 7, path: "audio/GT/GT_260-123286-0028.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

/////////////////////////////////////////////////////////////////////////////////////////////////////////

  {
    groupName: "Group17 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-288.wav",
    refSubtitle: "What is the forecast for starting at 3 a.m. in Dubults for wrong weather?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_testAditi-snips-test-288.wav",hidden_method: "M8" },
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_testAditi-snips-test-288.wav" ,hidden_method: "M12"},
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_testAditi-snips-test-288.wav" ,hidden_method: "M9"},
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_testAditi-snips-test-288.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_testAditi-snips-test-288.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_testAditi-snips-test-288.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group18 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-531.wav",
    refSubtitle: "Look for the television show me the prince", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_testAditi-snips-test-531.wav",hidden_method: "M8" },
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_testAditi-snips-test-531.wav",hidden_method: "M12" },
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_testAditi-snips-test-531.wav",hidden_method: "M9" },
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_testAditi-snips-test-531.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_testAditi-snips-test-531.wav" ,hidden_method: "M16"},
      { id: 6, path: "audio/GT/GT_testAditi-snips-test-531.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group19 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_testAditi-snips-test-580.wav",
    refSubtitle: "Please find me the journal of the british astronomical association movie.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_testAditi-snips-test-580.wav",hidden_method: "M8" },
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_testAditi-snips-test-580.wav",hidden_method: "M12" },
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_testAditi-snips-test-580.wav",hidden_method: "M9" },
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_testAditi-snips-test-580.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_testAditi-snips-test-580.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_testAditi-snips-test-580.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group20 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_test_clean_1320-122612-0007.wav",
    refSubtitle: "Chingachgook had caught the look, and motioning with his hand, he bade him speak.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_test_clean_1320-122612-0007.wav" ,hidden_method: "M8"},
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_test_clean_1320-122612-0007.wav",hidden_method: "M12" },
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_test_clean_1320-122612-0007.wav" ,hidden_method: "M9"},
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_test_clean_1320-122612-0007.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_test_clean_1320-122612-0007.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_test_clean_1320-122612-0007.wav",hidden_method: "M0" },
      // 添加更多模型音频...
    ]
  },
  
  {
    groupName: "Group21 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_test_clean_7729-102255-0036.wav",
    refSubtitle: "He planted a company before the hotel and demanded a surrender of the arms belonging to the Free State Military Companies.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_test_clean_7729-102255-0036.wav",hidden_method: "M8" },
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_test_clean_7729-102255-0036.wav",hidden_method: "M12" },
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_test_clean_7729-102255-0036.wav",hidden_method: "M9" },
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_test_clean_7729-102255-0036.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_test_clean_7729-102255-0036.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_test_clean_7729-102255-0036.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group22 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Could you increase the heating?", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M8" },
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M12" },
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M9" },
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M16"},
      { id: 6, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_1f3fba10-4632-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group23 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",
    refSubtitle: "Okay, now switch the main language to Korean.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M8"},
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M12"},
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M9"},
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M13"},
      { id: 5, path: "audio/speex/3000bps/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_wavs_speakers_7NqqnAOPVVSKnxyv_e3bd7690-4630-11e9-bc65-55b32b211b66.wav" ,hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

  {
    groupName: "Group24 (Bitrate: ~300bps)", // 
    refAudio: "audio/GT/GT_260-123286-0028.wav",
    refSubtitle: "Its jaw is enormous and according to naturalists it is armed with no less than one hundred and eighty two teeth.", // 新增字幕字段
    models: [
      { id: 1, path: "audio/recon/SemantiCodec/0.31k/SC0.31k_260-123286-0028.flac" ,hidden_method: "M8"},
      { id: 2, path: "audio/recon/Ours/0.3k/Ours0.3k_260-123286-0028.flac" ,hidden_method: "M12"},
      { id: 3, path: "audio/recon/SemantiCodec/0.35k/SC0.35k_260-123286-0028.flac",hidden_method: "M9" },
      { id: 4, path: "audio/recon/Ours/0.35k/Ours0.35k_260-123286-0028.flac",hidden_method: "M13" },
      { id: 5, path: "audio/speex/3000bps/GT_260-123286-0028.wav",hidden_method: "M16" },
      { id: 6, path: "audio/GT/GT_260-123286-0028.wav",hidden_method: "M0"},
      // 添加更多模型音频...
    ]
  },

]; //放音频序列

//随机打乱顺序-start//////////////
// 固定乱序：使用 localStorage 保存乱序后的 ID 顺序
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// 为每组生成唯一的键名，例如 Group17 => group_shuffle_17
function getShuffleKey(groupName) {
  return `shuffle_${groupName.replace(/\s+/g, '_')}`;
}

////////////

// 替换为以下代码
// 增强版随机播放逻辑
audioGroups.forEach(group => {
  const key = getShuffleKey(group.groupName);
  
  if (!localStorage.getItem(key)) {
    // 首次加载：创建真正随机的播放顺序
    const shuffled = group.models
      .map(m => ({...m, sortKey: Math.random()})) // 为每个音频添加随机键
      .sort((a,b) => a.sortKey - b.sortKey);      // 按随机键排序
    
    // 保存顺序到localStorage
    localStorage.setItem(key, JSON.stringify(shuffled.map(m => m.hidden_method || m.id)));
    
    // 添加显示用的顺序编号
    group.models = shuffled.map((m, i) => ({...m, displayId: i+1}));
  } else {
    // 已有顺序：从缓存恢复
    const order = JSON.parse(localStorage.getItem(key));
    group.models.sort((a, b) => 
      order.indexOf(a.hidden_method || a.id) - order.indexOf(b.hidden_method || b.id)
    );
    // 添加显示用的顺序编号
    group.models.forEach((m, i) => m.displayId = i+1);
  }
});
/////////////

// /随机打乱顺序-end///////////////
// 生成组
audioGroups.forEach((group, index) => {
  const groupDiv = document.createElement('div');
  groupDiv.className = 'group' + (index === 0 ? ' active' : '');

  const title = document.createElement('h2');
  title.textContent = group.groupName;
  groupDiv.appendChild(title);

  const table = document.createElement('table');
  table.className = 'score-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th width="10%">编号</th>
      <th width="60%">音频播放</th>
      <th width="30%">打分 (0-100)</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  // 参考音频
  const refRow = document.createElement('tr');
  refRow.innerHTML = `
    <td><b>参考</b></td>
    <td colspan="2">
      <audio controls src="${group.refAudio}"></audio>
      <div class="subtitle">${group.refSubtitle}</div>  
      </td>
  `;
  tbody.appendChild(refRow);



  // 模型音频
  
//////////////////////////////


group.models.forEach(model => {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${model.displayId}</td>  <!-- 改为使用displayId -->
    <td><audio controls src="${model.path}"></audio></td> 
    <td><input type="number" min="0" max="100" 
         data-group="${index + 1}" 
         data-model="model${model.id}" 
         data-hidden="${model.hidden_method || ''}"
         data-original-id="${model.id}">
    </td>
  `;
  tbody.appendChild(row);
});
////////////////////


  table.appendChild(tbody);
  groupDiv.appendChild(table);
  groupsContainer.appendChild(groupDiv);
});

// 可以在脚本最后添加这个函数
function resetAudioOrder() {
  if(confirm('确定要重置所有音频的播放顺序吗？')){
    audioGroups.forEach(group => {
      localStorage.removeItem(getShuffleKey(group.groupName));
    });
    location.reload();
  }
}
  ////////////////////////////////////////////

  function showGroup(index) {
    const groups = document.querySelectorAll('.group');
    groups.forEach((g, i) => {
      g.classList.toggle('active', i === index);
    });
    updateOverallProgress();
    updateGroupControls();
  }

  function updateGroupControls() {
    document.getElementById('prev-group').disabled = currentGroupIndex === 0;
    document.getElementById('next-group').disabled = currentGroupIndex === totalGroups - 1;
    document.getElementById('current-group').textContent = currentGroupIndex + 1;
  }

  // 添加在现有函数附近（例如放在updateGroupControls函数后面）
  function checkCurrentGroupScores() {
    const currentGroup = document.querySelector('.group.active');
    const inputs = currentGroup.querySelectorAll('input[type="number"]');
    
    for (let input of inputs) {
      if (input.value === "" || isNaN(input.value)) {
        return false;
      }
    }
    return true;
  }


  document.getElementById('prev-group').addEventListener('click', () => {
    if (currentGroupIndex > 0) {
      currentGroupIndex--;
      showGroup(currentGroupIndex);
    }
  });
  /////////////////////////////
  // document.getElementById('next-group').addEventListener('click', () => {
  //   if (currentGroupIndex < totalGroups - 1) {
  //     currentGroupIndex++;
  //     showGroup(currentGroupIndex);
  //   }
  // });
  /////////////////////////////////
  // 改为新的实现
  document.getElementById('next-group').addEventListener('click', () => {
    if (!checkCurrentGroupScores()) {
      alert('请完成当前组所有打分后再继续！');
      const currentGroup = document.querySelector('.group.active');
      const inputs = currentGroup.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        if (input.value === "" || isNaN(input.value)) {
          input.classList.add('missing-score-input');
          input.parentElement.parentElement.classList.add('highlight-missing');
        }
      });
      return;
    }
    
    if (currentGroupIndex < totalGroups - 1) {
      currentGroupIndex++;
      showGroup(currentGroupIndex);
    }
  });

  ///////////////////////////////////

  function updateOverallProgress() {
    document.getElementById('overall-progress').textContent = `当前组 ${currentGroupIndex + 1}/${totalGroups}`;
  }
//   
// 检查是否有未打分的项目
function checkMissingScores() {
  const inputs = document.querySelectorAll('input[type="number"]');
  let missingScores = {};
  
  inputs.forEach(input => {
    const group = input.dataset.group;
    const model = input.dataset.model;
    const value = input.value;
    
    if (value === "" || isNaN(value)) {
      if (!missingScores[group]) {
        missingScores[group] = [];
      }
      missingScores[group].push(model);
      
      // 高亮显示未打分的输入框
      input.classList.add('missing-score-input');
      input.parentElement.parentElement.classList.add('highlight-missing');
    } else {
      // 移除高亮
      input.classList.remove('missing-score-input');
      input.parentElement.parentElement.classList.remove('highlight-missing');
    }
  });
  
  return missingScores;
}

// 显示未打分提示
function showMissingScoresAlert(missingScores) {
  let alertMessage = "以下项目未打分，请完成所有打分后再保存：\n\n";
  
  for (const group in missingScores) {
    alertMessage += `Group ${group}:\n`;
    missingScores[group].forEach(model => {
      alertMessage += `  - ${model}\n`;
    });
    alertMessage += "\n";
  }
  
  // 创建提示元素
  const alertDiv = document.createElement('div');
  alertDiv.className = 'missing-scores';
  alertDiv.textContent = "请完成所有打分后再保存（红色高亮显示未打分项）";
  
  const existingAlert = document.querySelector('.missing-scores');
  if (existingAlert) {
    existingAlert.replaceWith(alertDiv);
  } else {
    document.querySelector('.result-buttons').before(alertDiv);
  }
  
  // 滚动到第一个未打分的项目
  const firstMissing = document.querySelector('.missing-score-input');
  if (firstMissing) {
    firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
    firstMissing.focus();
  }
  
  return false;
}
// 

  function updateProgress(group) {
    const inputs = document.querySelectorAll(`input[data-group="${group}"]`);
    let filled = 0;
    inputs.forEach(input => {
      if (input.value !== "") filled++;
    });
  }

  function saveScoresToStorage() {
    const inputs = document.querySelectorAll('input[type="number"]');
    let scores = {};
    inputs.forEach(input => {
      const group = input.dataset.group;
      const model = input.dataset.model;
      const value = input.value;
      if (!scores[group]) scores[group] = {};
      scores[group][model] = value;
    });
    localStorage.setItem('mushraScores', JSON.stringify(scores));
  }

  function loadScoresFromStorage() {
    const saved = localStorage.getItem('mushraScores');
    if (saved) {
      const scores = JSON.parse(saved);
      for (const group in scores) {
        for (const model in scores[group]) {
          const input = document.querySelector(`input[data-group="${group}"][data-model="${model}"]`);
          if (input) {
            input.value = scores[group][model];
          }
        }
      }
    }
  }

////////////////////////////////////////////////////////
//   document.addEventListener('input', (e) => {
//     if (e.target.matches('input[type="number"]')) {
//       const group = e.target.dataset.group;
//       updateProgress(group);
//       saveScoresToStorage();
//     }
//   });
/////////////////////////////////////////////////////////
// 在输入时移除高亮
document.addEventListener('input', (e) => {
  if (e.target.matches('input[type="number"]')) {
    const group = e.target.dataset.group;
    updateProgress(group);
    saveScoresToStorage();
    
    // 移除高亮
    e.target.classList.remove('missing-score-input');
    e.target.parentElement.parentElement.classList.remove('highlight-missing');
    
    // 如果没有未打分的项目，移除提示
    const missingScores = checkMissingScores();
    if (Object.keys(missingScores).length === 0) {
      const existingAlert = document.querySelector('.missing-scores');
      if (existingAlert) {
        existingAlert.remove();
      }
    }
  }
});





function collectScores() {
  const missingScores = checkMissingScores();
  
  if (Object.keys(missingScores).length > 0) {
    return showMissingScoresAlert(missingScores);
  }
  
  const inputs = document.querySelectorAll('input[type="number"]');
  let results = {};

  inputs.forEach(input => {
    const group = input.dataset.group;
    // const model = input.dataset.model;
    const model = input.dataset.hidden || input.dataset.model;
    const score = input.value;

    if (!results[`Group ${group}`]) {
      results[`Group ${group}`] = {};
    }
    results[`Group ${group}`][model] = score;
  });

  let resultText = "";
  for (const [group, models] of Object.entries(results)) {
    resultText += `${group}:\n`;
    for (const [model, score] of Object.entries(models)) {
      resultText += `  ${model}: ${score}\n`;
    }
    resultText += '\n';
  }

  document.getElementById('results').value = resultText;
  
  // 移除未打分提示（如果有）
  const existingAlert = document.querySelector('.missing-scores');
  if (existingAlert) {
    existingAlert.remove();
  }
     // ✅ 如果都打完分，显示感谢抽奖弹窗
    //  showThankYou();
    document.getElementById('completionModal').style.display = 'flex';
  return true;
}







function downloadScores() {
  const missingScores = checkMissingScores();
  if (Object.keys(missingScores).length > 0) {
    return showMissingScoresAlert(missingScores);
  }
  
  collectScores(); // 确保结果是最新的
  const text = document.getElementById('results').value;
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement("a");
  link.href = url;
  link.download = `MUSHRA_评分结果_${new Date().toLocaleString('zh-CN')}.txt`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

///////////////////////////////////////////////////////////////////////////////

// 修改后的clearScores函数
function clearScores() {
  if (confirm("确定要清空所有已打分的数据吗？")) {
    localStorage.removeItem('mushraScores');
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.value = '';
      input.classList.remove('missing-score-input');
      input.parentElement.parentElement.classList.remove('highlight-missing');
    });
    document.getElementById('results').value = '';
    
    // 移除未打分提示（如果有）
    const existingAlert = document.querySelector('.missing-scores');
    if (existingAlert) {
      existingAlert.remove();
    }
  }
}
////////////////////////////////////////////////////////
function downloadAndClose() {
  closeModal();
  downloadScores(); // 调用现有的下载函数
}

function closeModal() {
  document.getElementById('completionModal').style.display = 'none';
}

///////////////////
  // 新增：更新实时结果框函数
function updateResultsBox() {
  const inputs = document.querySelectorAll('input[type="number"]');
  let results = {};

  inputs.forEach(input => {
    const group = input.dataset.group;
    const model = input.dataset.hidden || input.dataset.model;
    const score = input.value;

    if (!results[`Group ${group}`]) {
      results[`Group ${group}`] = {};
    }
    results[`Group ${group}`][model] = score;
  });

  let resultText = "";
  for (const [group, models] of Object.entries(results)) {
    resultText += `${group}:
`;
    for (const [model, score] of Object.entries(models)) {
      resultText += `  ${model}: ${score}\n`;
    }
    resultText += '\n';
  }

  document.getElementById('results').value = resultText;
}


// 修改 input 监听器，加入实时结果更新功能
document.addEventListener('input', (e) => {
  if (e.target.matches('input[type="number"]')) {
    const group = e.target.dataset.group;
    updateProgress(group);
    saveScoresToStorage();
    updateResultsBox(); // 实时更新

    // 移除高亮提示
    e.target.classList.remove('missing-score-input');
    e.target.parentElement.parentElement.classList.remove('highlight-missing');

    const missingScores = checkMissingScores();
    if (Object.keys(missingScores).length === 0) {
      const existingAlert = document.querySelector('.missing-scores');
      if (existingAlert) existingAlert.remove();
    }
  }
});
////////////////////

/////////////////
// 页面加载时自动刷新分数框
window.onload = () => {
  loadScoresFromStorage();
  updateOverallProgress();
  updateGroupControls();
  updateResultsBox();
}

////////////////



</script>



</body>
</html>